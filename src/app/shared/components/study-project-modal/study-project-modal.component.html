<app-base-dialog
  [data]="data"
  [disableSubmitBtn]="disableSubmitBtn"
  [formValid]="form.valid"
  (submitted)="onSubmit()"
  (cancelled)="onCancel()"
>
  <form autocomplete="off" [formGroup]="form">
    <mat-tab-group
      class="modal-tabs"
      [preserveContent]="true"
      [selectedIndex]="selectedTabIndex"
      (selectedTabChange)="onSelectedTabChange($event)"
      #tabGroup
    >
      <mat-tab formGroupName="basicsTab">
        <ng-template mat-tab-label>
          <!-- For tab labels -->
          <div class="custom-tab-label" [class.no-border]="isBasicsTabValid()">
            <svg *ngIf="isBasicsTabValid()" width="1rem" height="1rem" class="ms-1">
              <use [attr.xlink:href]="'assets/icons/sprite.svg#green-circle'"></use>
            </svg>
            <span [class.green-500]="isBasicsTabValid()">{{
              'actions.study.basicData' | translate
            }}</span>
          </div>
        </ng-template>
        <div class="row gx-3">
          <!-- start document type -->
          <div class="col-12 col-md-6 mb-3">
            <p class="body-bold text-small mb-2">
              {{ 'SharedModule.StudyProjectModalComponent.proposedStudyOutcome' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-select
              formControlName="exportType"
              [options]="exportedDocumentTypeOptions"
              [bindLabel]="'title'"
              [bindValue]="'value'"
              [placeholder]="
                'SharedModule.StudyProjectModalComponent.chooseProposedStudyOutcome' | translate
              "
              [multiple]="false"
              [searchable]="false"
              [disabled]="this.data.actionType !== ActionType.ExportTypeRecommendation"
            >
            </app-select>

            <div
              *ngIf="form.get('exportType')?.invalid && form.get('exportType')?.touched"
              class="text-danger mt-1"
            >
              <small>
                {{
                  'SharedModule.StudyProjectModalComponent.proposedStudyOutcomeRequired' | translate
                }}
              </small>
            </div>
          </div>
          <!-- end document type-->

          <!-- start record type -->
          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Record"
            class="col-12 col-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'ManageRecordsModule.RecordDetailsComponent.recordType' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-select
              formControlName="recordType"
              [options]="recordTypeOptions"
              [bindLabel]="'title'"
              [bindValue]="'value'"
              [placeholder]="
                'ManageRecordsModule.RecordsListComponent.recordTypePlaceholder' | translate
              "
              [multiple]="false"
              [searchable]="false"
            >
            </app-select>

            <div
              *ngIf="
                basicsTab.errors?.['recordTypeRequired'] &&
                                 isTouched('basicsTab','recordType')
              "
              class="text-danger mt-1"
            >
              <small>
                {{ 'SharedModule.StudyProjectModalComponent.recordTypeRequired' | translate }}
              </small>
            </div>
          </div>
          <!-- end record type-->

          <!-- start note type -->
          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Note"
            class="col-12 col-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'actions.study.noteType.label' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-select
              formControlName="noteType"
              [options]="noteTypeOptions"
              [bindLabel]="'title'"
              [bindValue]="'value'"
              [placeholder]="'actions.study.noteType.placeholder' | translate"
              [multiple]="false"
              [searchable]="false"
              [appendTo]="'body'"
            >
            </app-select>

            <div
              *ngIf="(basicsTab.errors?.['noteTypeRequired'] || basicsTab.get('noteType')?.errors?.['required']) &&
                                 (isTouched('basicsTab','noteType') || basicsTab.get('noteType')?.touched)
                           "
              class="text-danger mt-1"
            >
              <small>
                {{ 'actions.study.noteType.required' | translate }}
              </small>
            </div>
          </div>
          <!-- end note type-->

          <!-- start نوع المذكرة اخري -->
          <div
            *ngIf="
              basicsTab.get('exportType')?.value === ExportedDocumentType.Note &&
              basicsTab.get('noteType')?.value === NoteType.Other
            "
            class="col-12 col-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'actions.study.noteType.other' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-input
              formControlName="otherNoteType"
              [placeholder]="'shared.searchByAddress'"
              [showSearchIcon]="false"
              [showFilterIcon]="false"
            ></app-input>

            <div
              *ngIf=" basicsTab.errors?.['otherNoteTypeRequired'] && isTouched('basicsTab','otherNoteType')"
              class="text-danger mt-1"
            >
              <small>
                {{ 'actions.study.noteType.otherRequired' | translate }}
              </small>
            </div>
          </div>
          <!-- end نوع المذكرة اخري-->

          <!-- start letter type -->
          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Letter"
            class="col-12 col-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'actions.study.letterType.label' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-select
              formControlName="letterType"
              [options]="letterTypeOptions"
              [bindLabel]="'title'"
              [bindValue]="'value'"
              [placeholder]="'actions.study.letterType.placeholder' | translate"
              [multiple]="false"
              [searchable]="false"
              [appendTo]="'body'"
            >
            </app-select>

            <!-- <div
              *ngIf=" basicsTab.errors?.['letterTypeRequired'] && isTouched('basicsTab','letterType')"
              class="text-danger mt-1"
            >
              <small>
                {{ 'actions.study.letterType.required' | translate }}
              </small>
            </div> -->
          </div>
          <!-- end letter type-->

          <!-- start committeeId-->
          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Record"
            class="col-12 col-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'shared.processType' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-select
              formControlName="committeeId"
              [options]="organizationUnitsList"
              [bindLabel]="'committeeSymbol'"
              [bindValue]="'id'"
              [placeholder]="'shared.chooseProcessType' | translate"
              [multiple]="false"
              [searchable]="false"
              [appendTo]="'body'"
            >
            </app-select>

            <div
              *ngIf=" basicsTab.errors?.['committeeRequired'] &&
                isTouched('basicsTab','committeeId') &&
                !basicsTab.get('committeeId')?.value"
              class="text-danger mt-1"
            >
              <small>
                {{
                  'SharedModule.SelectProcessTypeModalComponent.selectProcessTypeRequired'
                    | translate
                }}
              </small>
            </div>
          </div>
          <!-- end committeeId -->

          <!-- start processTypeJustificationsIds-->
          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Record"
            class="col-12 col-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'shared.processTypeJustifications' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-select
              formControlName="processTypeJustificationsIds"
              [options]="processTypeJustificationsList"
              [bindLabel]="lang === 'ar' ? 'title' : 'titleEn'"
              [bindValue]="'id'"
              [placeholder]="
                'TransactionsModule.AddTransactionComponent.referralJustificationsPlaceholder'
                  | translate
              "
              [multiple]="true"
              [showSelected]="true"
              [searchable]="false"
              [appendTo]="'body'"
            >
            </app-select>

            <div
              *ngIf=" basicsTab.errors?.['processTypeJustificationsRequired'] &&
                isTouched('basicsTab','processTypeJustificationsIds') &&
                (!basicsTab.get('processTypeJustificationsIds')?.value || basicsTab.get('processTypeJustificationsIds')?.value.length === 0)"
              class="text-danger mt-1"
            >
              <small>
                {{ 'SharedModule.StudyProjectModalComponent.processTypeJustRequired' | translate }}
              </small>
            </div>
          </div>
          <!-- end processTypeJustificationsIds -->
          <!-- start committeeChangeReason textArea -->
          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Record"
            class="col-12 col-md-6 offset-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'SharedModule.StudyProjectModalComponent.explainProcessTypeJust' | translate }}
            </p>

            <textarea
              class="form-control w-100"
              rows="3"
              [placeholder]="
                'SharedModule.StudyProjectModalComponent.explainProcessTypeJustPlaceholder'
                  | translate
              "
              formControlName="committeeChangeReason"
              id="comment"
              (keyup)="x()"
            ></textarea>
          </div>
          <!-- end committeeChangeReason textArea -->

          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Record"
            class="col-12 col-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{
                'SharedModule.SelectRecommendationTypeModalComponent.chooseRecommendation'
                  | translate
              }}
              <span class="text-danger">*</span>
            </p>
            <app-select
              formControlName="recommendationType"
              [options]="(recommendationTypesList$ | async)?.data"
              [bindLabel]="'title'"
              [bindValue]="'id'"
              [placeholder]="
                'SharedModule.SelectRecommendationTypeModalComponent.chooseRecommendationRequired'
                  | translate
              "
              [multiple]="false"
              [searchable]="false"
              [appendTo]="'body'"
            >
            </app-select>

            <div
              *ngIf="basicsTab.errors?.['recommendationTypeRequired'] &&
                  isTouched('basicsTab','recommendationType') &&
                  !basicsTab.get('recommendationType')?.value"
              class="text-danger mt-1"
            >
              <small>
                {{
                  'SharedModule.SelectRecommendationTypeModalComponent.recommendationRequired'
                    | translate
                }}
              </small>
            </div>
          </div>
          <!-- start outcomeId-->
          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Record"
            class="col-12 col-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'shared.recommendationOutcomes' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-select
              formControlName="outcomeId"
              [options]="outComesList"
              [bindLabel]="lang === 'ar' ? 'title' : 'titleEn'"
              [bindValue]="'id'"
              [placeholder]="'shared.chooseRecommendationOutcome' | translate"
              [multiple]="false"
              [searchable]="false"
              [appendTo]="'body'"
            >
            </app-select>

            <div
              *ngIf=" basicsTab.errors?.['outcomeRequired']&&
                      isTouched('basicsTab','outcomeId') &&
                      !basicsTab.get('outcomeId')?.value"
              class="text-danger mt-1"
            >
              <small>
                {{ 'SharedModule.StudyProjectModalComponent.outcomeRequired' | translate }}
              </small>
            </div>
          </div>
          <!-- end outcomeId -->

          <!-- start extendDays  -->
          <div
            *ngIf="
              basicsTab.get('exportType')?.value === ExportedDocumentType.Record &&
              basicsTab.get('recommendationType')?.value === environment.extendInvestigationId
            "
            class="col-12 col-md-6 offset-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'actions.study.extend' | translate }}
            </p>
            <app-input
              [type]="'number'"
              formControlName="extendDays"
              [placeholder]="'actions.study.extend'"
              [showSearchIcon]="false"
              [showFilterIcon]="false"
            ></app-input>
          </div>
          <!-- end extendDays  -->

          <!-- start textArea -->
          <div
            *ngIf="basicsTab.get('exportType')?.value === ExportedDocumentType.Record"
            class="col-12 col-md-6 offset-md-6 mb-3"
          >
            <p class="body-bold text-small mb-2">
              {{ 'SharedModule.StudyProjectModalComponent.recommendationTypeComment' | translate }}
            </p>

            <textarea
              class="form-control w-100"
              rows="3"
              [placeholder]="
                'SharedModule.StudyProjectModalComponent.recommendationTypeCommentPlaceholder'
                  | translate
              "
              formControlName="recommendationTypeComment"
              id="comment"
              (keyup)="x()"
            ></textarea>
          </div>
          <!-- end textArea -->
          <!-- start textArea -->
          <div class="col-12 col-md-6 offset-md-6 mb-3">
            <p class="body-bold text-small mb-2">
              {{ 'shared.extraNotes' | translate }}
            </p>

            <textarea
              class="form-control w-100"
              rows="3"
              [placeholder]="'shared.extraNotesPlaceholder' | translate"
              formControlName="comment"
              id="comment"
              (keyup)="x()"
            ></textarea>
          </div>
          <!-- end textArea -->
        </div>
      </mat-tab>
      <mat-tab
        formGroupName="amountsTab"
        *ngIf="
          basicsTab.get('exportType')?.value === ExportedDocumentType.Record &&
          basicsTab.get('recommendationType')?.value !== environment.extendInvestigationId
        "
      >
        <ng-template mat-tab-label>
          <!-- For tab labels -->
          <div class="custom-tab-label" [class.no-border]="isAmountsTabValid()">
            <svg *ngIf="isAmountsTabValid()" width="1rem" height="1rem" class="ms-1">
              <use [attr.xlink:href]="'assets/icons/sprite.svg#green-circle'"></use>
            </svg>
            <span [class.green-500]="isAmountsTabValid()">{{
              'actions.study.creditsAndCosts' | translate
            }}</span>
          </div>
        </ng-template>
        <div class="row gx-3">
          <p class="body-bold mb-2">
            {{ 'ImportsExportsModule.AddImportComponent.costsRequestedAmount' | translate }}
          </p>
          <div class="col-md-6 col-12">
            <!-- start cost request -->
            <p class="body-bold text-small mb-2">
              {{ 'shared.costs' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-input
              formControlName="costsRequestedAmount"
              [placeholder]="'actions.study.costs'"
              [showSearchIcon]="false"
              [showFilterIcon]="false"
              [appCurrencySarInput]="true"
              [showriyalIcon]="true"
            ></app-input>

            <div
              *ngIf="  form.errors?.['costsRequestedAmountRequired'] &&
              isTouched('amountsTab', 'costsRequestedAmount')"
              class="text-danger mt-1"
            >
              <small>
                {{ 'SharedModule.StudyProjectModalComponent.amountRequired' | translate }}
              </small>
            </div>
            <!-- end  cost request -->
          </div>

          <div class="col-md-6 col-12">
            <!-- start  credit request -->

            <p class="body-bold text-small mb-2">
              {{ 'shared.credits' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-input
              formControlName="creditsRequestedAmount"
              [appCurrencySarInput]="true"
              [showriyalIcon]="true"
              [placeholder]="'actions.study.credits'"
              [showSearchIcon]="false"
              [showFilterIcon]="false"
            ></app-input>

            <div
              *ngIf="form.errors?.['creditsRequestedAmountRequired'] &&
              isTouched('amountsTab', 'creditsRequestedAmount')"
              class="text-danger mt-1"
            >
              <small>
                {{ 'SharedModule.StudyProjectModalComponent.amountRequired' | translate }}
              </small>
            </div>
            <!-- end credit request  -->
          </div>
          <p class="body-bold mb-2 mt-3">
            {{ 'ImportsExportsModule.AddImportComponent.creditsRequestedAmount' | translate }}
          </p>
          <div class="col-md-6 col-12">
            <!-- start cost request -->
            <p class="body-bold text-small mb-2">
              {{ 'shared.costs' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-input
              formControlName="costsApprovedAmount"
              [placeholder]="'actions.study.costs'"
              [showSearchIcon]="false"
              [showFilterIcon]="false"
              [appCurrencySarInput]="true"
              [showriyalIcon]="true"
            ></app-input>

            <div
              *ngIf="  form.errors?.['costsApprovedAmountRequired'] &&
              isTouched('amountsTab', 'costsApprovedAmount')"
              class="text-danger mt-1"
            >
              <small>
                {{ 'SharedModule.StudyProjectModalComponent.amountRequired' | translate }}
              </small>
            </div>
            <!-- end  cost approved -->
          </div>
          <div class="col-md-6 col-12">
            <!-- start  credit request -->

            <p class="body-bold text-small mb-2">
              {{ 'shared.credits' | translate }}
              <span class="text-danger">*</span>
            </p>
            <app-input
              formControlName="creditsApprovedAmount"
              [appCurrencySarInput]="true"
              [showriyalIcon]="true"
              [placeholder]="'actions.study.credits'"
              [showSearchIcon]="false"
              [showFilterIcon]="false"
            ></app-input>

            <div
              *ngIf="form.errors?.['creditsApprovedAmountRequired'] &&
              isTouched('amountsTab', 'creditsApprovedAmount')"
              class="text-danger mt-1"
            >
              <small>
                {{ 'SharedModule.StudyProjectModalComponent.amountRequired' | translate }}
              </small>
            </div>
            <!-- end credit approved  -->
          </div>

          <p class="body-bold mt-3 mb-2">
            {{ 'actions.study.mechanism' | translate }}
          </p>

          <div class="col-12 col-md-6">
            <p class="body-bold text-small mb-2">
              {{ 'actions.study.creditMeasure' | translate }}
            </p>
            <app-select
              formControlName="creditsAmountMechanism"
              [options]="approvedAmountMechanismOptions"
              [bindLabel]="'title'"
              [bindValue]="'value'"
              [placeholder]="'actions.study.selectMechanismPlaceholder' | translate"
              [multiple]="false"
              [searchable]="false"
              [appendTo]="'body'"
            >
            </app-select>
          </div>

          <div class="col-12 col-md-6">
            <p class="body-bold text-small mb-2">
              {{ 'actions.study.costMeasures' | translate }}
            </p>
            <app-select
              formControlName="costsAmountMechanism"
              [options]="approvedAmountMechanismOptions"
              [bindLabel]="'title'"
              [bindValue]="'value'"
              [placeholder]="'actions.study.selectMechanismPlaceholder' | translate"
              [multiple]="false"
              [searchable]="false"
              [appendTo]="'body'"
            >
            </app-select>
          </div>
        </div>
      </mat-tab>

      <mat-tab formGroupName="attachmentsTab">
        <ng-template mat-tab-label>
          <!-- For tab labels -->
          <div class="custom-tab-label" [class.no-border]="isAttachmentsTabValid()">
            <svg *ngIf="isAttachmentsTabValid()" width="1rem" height="1rem" class="ms-1">
              <use [attr.xlink:href]="'assets/icons/sprite.svg#green-circle'"></use>
            </svg>
            <span [class.green-500]="isAttachmentsTabValid()">{{
              'actions.study.docs' | translate
            }}</span>
          </div>
        </ng-template>
        <div class="grid">
          <div class="row">
            <div class="col-12">
              <p class="body-bold text-small mb-2">
                {{ 'actions.study.studyDocuments' | translate }}
              </p>
              <div
                class="download-container mb-3"
                *ngIf="data.formFields.requestExportRecommendation && !showUpload"
              >
                <div class="d-flex align-items-center">
                  <svg width="1.5rem" height="1.5rem" class="ms-2">
                    <use [attr.xlink:href]="'assets/icons/sprite.svg#pdf'"></use>
                  </svg>
                  <span class="body-bold">
                    {{ attachmentsTab.get('originalUploadedFile')?.value?.name }}</span
                  >
                </div>
                <div class="d-flex align-items-center">
                  <svg
                    class="cursor-pointer"
                    width="1.5rem"
                    height="1.5rem"
                    (click)="onDownloadUploadedStudyDocumentAttachment()"
                    matTooltip="{{ 'shared.download' | translate }}"
                  >
                    <use [attr.xlink:href]="'assets/icons/sprite.svg#download'"></use>
                  </svg>

                  <svg
                    class="cursor-pointer"
                    width="1.5rem"
                    height="1.5rem"
                    (click)="deleteFile()"
                    matTooltip="{{ 'shared.delete' | translate }}"
                  >
                    <use [attr.xlink:href]="'assets/icons/sprite.svg#delete-sm'"></use>
                  </svg>
                </div>
              </div>
              <!-- //////////////////// -->
              <ng-container *ngIf="showUpload">
                <app-upload-attachment
                  #uploadAttachment2
                  [multiple]="true"
                  [showBtn]="false"
                  [split]="true"
                  [customFileTypes]="['.doc', '.docx']"
                  (fileUploaded)="onDocumentFileChangeToNotPatchInEditor($event)"
                ></app-upload-attachment>
              </ng-container>
            </div>
          </div>
          <!-- ////////////////////// -->
          <div class="row gx-3 custom-border-bottom">
            <div class="col-12">
              <p class="body-bold text-small mb-1">
                {{ 'actions.study.supportingDocuments' | translate }}
              </p>
              <p class="body text-small gray-700 mb-2">
                {{ 'actions.study.selectDocs' | translate }}
              </p>
              <!-- Start  Old attachments -->
              <ng-container *ngIf="oldAttachments?.value && oldAttachments?.value.length">
                <div
                  class="download-container mb-3"
                  *ngFor="let item of oldAttachments.controls; index as i"
                >
                  <div class="d-flex align-items-center">
                    <svg width="1.5rem" height="1.5rem" class="ms-2">
                      <use [attr.xlink:href]="'assets/icons/sprite.svg#pdf'"></use>
                    </svg>
                    <span class="body-bold">
                      {{ getFormControlByIndex(oldAttachments, i).value?.name }}</span
                    >
                  </div>
                  <svg
                    class="cursor-pointer"
                    width="1rem"
                    height="1rem"
                    [matTooltip]="getFormControlByIndex(oldAttachments, i).value?.name"
                    (click)="onViewFile(getFormControlByIndex(oldAttachments, i)?.value)"
                  >
                    <use [attr.xlink:href]="'assets/icons/sprite.svg#view'"></use>
                  </svg>
                </div>
              </ng-container>
              <!--End old attachments -->

              <!-- Start  New attachments -->
              <app-upload-attachment
                #uploadAttachment
                [multiple]="true"
                [showBtn]="false"
                [split]="true"
                (fileUploaded)="onFileDropped($event)"
              ></app-upload-attachment>

              <!-- General attachment validation error -->
              <div *ngIf="attachments.errors && attachments.touched" class="text-danger mt-1">
                <small>
                  {{ 'ManageDocumentsModule.AddDocumentPage.fileRequired' | translate }}
                </small>
              </div>
              <!-- End  New attachments -->
            </div>
          </div>
          <!-- ////////////////////// -->
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- Navigation Buttons -->
    <div class="d-flex mt-3">
      <span
        [class]="selectedTabIndex === 0 ? 'grey-700' : 'cursor-pointer'"
        (click)="selectedTabIndex > 0 && goToPreviousTab()"
        class="d-flex align-items-center"
      >
        <span [class]="selectedTabIndex === 0 ? 'grey-700' : 'primary-200'">{{
          'shared.previous' | translate
        }}</span>
        <svg width="1.5rem" height="1.5rem" class="">
          <use
            [attr.xlink:href]="
              selectedTabIndex === 0
                ? 'assets/icons/sprite.svg#prev-grey'
                : 'assets/icons/sprite.svg#prev-blue'
            "
          ></use>
        </svg>
      </span>

      <span
        [class]="isLastTab() ? 'gray-700' : 'cursor-pointer'"
        (click)="!isLastTab() && goToNextTab()"
        class="d-flex align-items-center mx-2"
      >
        <svg width="1.5rem" height="1.5rem" class="ms-1">
          <use
            [attr.xlink:href]="
              isLastTab()
                ? 'assets/icons/sprite.svg#next-grey'
                : 'assets/icons/sprite.svg#next-blue'
            "
          ></use>
        </svg>
        <span [class]="isLastTab() ? 'gray-700' : 'primary-200'">{{
          'shared.next' | translate
        }}</span>
      </span>
    </div>
  </form>
</app-base-dialog>
